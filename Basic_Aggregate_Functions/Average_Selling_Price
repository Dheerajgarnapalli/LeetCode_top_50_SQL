
select a.product_id ,IFNULL(round(sum(a.price*a.units)/b.total,2),0) as average_price
from 
(select p.product_id,p.price,u.units
from 
Prices p  left join UnitsSold u
on p.product_id=u.product_id and u.purchase_date between p.start_date and p.end_date) as a
left join
(
select t.product_id,sum(t.units) as total
from(
select p.product_id,p.price,u.units
from 
Prices p left join UnitsSold u
on p.product_id=u.product_id and u.purchase_date between p.start_date and p.end_date)as t
group by t.product_id) as b
on a.product_id = b.product_id
group by a.product_id;
